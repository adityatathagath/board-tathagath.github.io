import streamlit as st
import pandas as pd
import plotly.graph_objects as go

def plot_usdinr_chart_halfyear(df: pd.DataFrame):
    df.columns = df.columns.str.strip()
    df['Date'] = pd.to_datetime(df['Date'])
    df = df.sort_values('Date')

    # --- Half-Yearly Downsampling ---
    df_halfyear = df.resample('2QS', on='Date').mean().reset_index()  # Half-yearly

    # --- Major Events ---
    events = [
        {"date": "1973-08-15", "text": "📉 End of Bretton Woods"},
        {"date": "1991-07-01", "text": "💣 1991 BoP Crisis"},
        {"date": "1997-07-02", "text": "⚠️ Asian Financial Crisis"},
        {"date": "2000-03-01", "text": "💻 Dot-com Bubble"},
        {"date": "2008-09-15", "text": "🏦 Lehman Collapse"},
        {"date": "2013-05-22", "text": "💸 Taper Tantrum"},
        {"date": "2016-11-08", "text": "💰 Demonetization"},
        {"date": "2020-03-20", "text": "🦠 COVID Crash"},
        {"date": "2022-02-24", "text": "💣 Russia-Ukraine War"},
        {"date": "2023-03-01", "text": "🏛️ SVB Crisis"},
        {"date": "2024-05-01", "text": "🗳️ Election Season"},
        {"date": "2025-01-01", "text": "🔮 FX Outlook Shift"}
    ]

    # --- Base Plot with Half-Year Data ---
    fig = go.Figure()
    fig.add_trace(go.Scatter(
        x=df_halfyear['Date'],
        y=df_halfyear['USDINR'],
        mode='lines',
        line=dict(shape='spline', color='royalblue'),
        name='USD/INR (Half-Year Avg)'
    ))

    # --- Add Events ---
    for event in events:
        event_date = pd.to_datetime(event['date'])
        if df['Date'].min() <= event_date <= df['Date'].max():
            idx = (df['Date'] - event_date).abs().idxmin()
            y_val = df.loc[idx, 'USDINR']
            event_actual_date = df.loc[idx, 'Date']

            # Add marker at event
            fig.add_trace(go.Scatter(
                x=[event_actual_date],
                y=[y_val],
                mode='markers+text',
                marker=dict(color='crimson', size=8, symbol='circle'),
                text=[event['text']],
                textposition="top center",
                showlegend=False,
                hovertext=event['text']
            ))

            # Add vertical line
            fig.add_vline(x=event_actual_date, line=dict(color="gray", dash="dot", width=1))

    # --- Layout Enhancements ---
    fig.update_layout(
        title="USD/INR (1973–2025) — Clean Chart with Key Events",
        xaxis_title="Date",
        yaxis_title="USD/INR",
        template="plotly_white",
        height=650,
        margin=dict(l=40, r=40, t=80, b=40),
        hovermode="x unified",
        xaxis=dict(
            rangeselector=dict(
                buttons=[
                    dict(count=10, label="10Y", step="year", stepmode="backward"),
                    dict(count=20, label="20Y", step="year", stepmode="backward"),
                    dict(step="all")
                ]
            ),
            rangeslider=dict(visible=True),
            type="date"
        )
    )

    st.plotly_chart(fig, use_container_width=True)

# Example:
# df = pd.read_excel("your_usdinr_data.xlsx")
# plot_usdinr_chart_halfyear(df)