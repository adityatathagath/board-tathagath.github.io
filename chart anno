import streamlit as st
import pandas as pd
import plotly.graph_objects as go

# Use your passed DataFrame directly
# Example: df = your_dataframe
def plot_usdinr_chart(df: pd.DataFrame):
    df.columns = df.columns.str.strip()
    df['Date'] = pd.to_datetime(df['Date'])
    df = df.sort_values('Date')

    fig = go.Figure()

    # Plot USDINR Line
    fig.add_trace(go.Scatter(
        x=df['Date'], y=df['USDINR'],
        mode='lines',
        line=dict(color='royalblue'),
        name='USD/INR'
    ))

    # Annotated events with emojis
    events = [
        {"date": "1973-08-15", "text": "ğŸ“‰ End of Bretton Woods"},
        {"date": "1991-07-01", "text": "ğŸ’£ 1991 BoP Crisis"},
        {"date": "1997-07-02", "text": "âš ï¸ Asian Financial Crisis"},
        {"date": "2000-03-01", "text": "ğŸ’» Dot-com Bubble"},
        {"date": "2008-09-15", "text": "ğŸ¦ Lehman Collapse"},
        {"date": "2013-05-22", "text": "ğŸ’¸ Taper Tantrum"},
        {"date": "2016-11-08", "text": "ğŸ’° Demonetization"},
        {"date": "2019-08-05", "text": "ğŸ›‘ Article 370 Removed"},
        {"date": "2020-03-20", "text": "ğŸ¦  COVID Crash"},
        {"date": "2022-02-24", "text": "ğŸ’£ Russia-Ukraine War"},
        {"date": "2022-09-01", "text": "ğŸ”º USD Peak 2022"},
        {"date": "2023-03-01", "text": "ğŸ›ï¸ SVB Crisis (US Banks)"},
        {"date": "2024-05-01", "text": "ğŸ—³ï¸ India Election Season"},
        {"date": "2025-01-01", "text": "ğŸ”® FX Outlook Turning"}
    ]

    # Add annotations
    for event in events:
        event_date = pd.to_datetime(event['date'])
        closest_idx = (df['Date'] - event_date).abs().idxmin()
        y_val = df.loc[closest_idx, 'USDINR']

        fig.add_trace(go.Scatter(
            x=[df.loc[closest_idx, 'Date']],
            y=[y_val],
            mode="markers+text",
            marker=dict(size=9, color='crimson', symbol='x'),
            text=[event["text"]],
            textposition="top center",
            name=event["text"],
            showlegend=False
        ))

    # Clean Layout
    fig.update_layout(
        title="ğŸ“ˆ USD/INR Exchange Rate (1973â€“2025) with Key Historical Annotations",
        xaxis_title="Date",
        yaxis_title="USD/INR",
        template="plotly_white",
        height=650,
        margin=dict(l=40, r=40, t=80, b=40),
        hovermode="x unified"
    )

    st.plotly_chart(fig, use_container_width=True)

# Example use:
# df = pd.read_excel("usdinr_data.xlsx")  # Already done on your side
# plot_usdinr_chart(df)