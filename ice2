import xlwings as xw
import os

def copy_range_exact(src_range, dest_range):
    # Use Excel's native copy-paste to preserve all formatting and values
    src_range.api.Copy()
    dest_range.api.PasteSpecial(Paste=-4104)  # xlPasteAll

# === File Paths ===
source_path = r"C:\path\to\ice_vectors.xlsb"  # <-- Update this
output_path = r"C:\path\to\output\DVaR_Output.xlsx"  # <-- Update this

# === Start Excel & Open Workbook ===
app = xw.App(visible=False)  # Set to True for debugging
wb = app.books.open(source_path)
summary = wb.sheets['summary']

# Refresh all calculations (Shift + F9 equivalent)
app.calculate()

# Set 'Var' to 'DVaR'
summary.range('C3').value = "DVaR"

# === Create New Workbook ===
output_wb = xw.Book()
output_wb.sheets[0].name = 'DVaR'

for rank in range(1, 4):
    # Set P&L Rank
    summary.range('C2').value = rank
    app.calculate()

    # For Rank 1: Copy AA14:BB54 → DVaR sheet
    if rank == 1:
        src_range1 = summary.range('AA14:BB54')
        dest_range1 = output_wb.sheets['DVaR'].range('A1')
        copy_range_exact(src_range1, dest_range1)

    # Copy B13:Y140 → new sheet DVaR PL1, PL2, PL3
    sheet_name = f"DVaR PL{rank}"
    output_wb.sheets.add(name=sheet_name)
    src_range2 = summary.range('B13:Y140')
    dest_range2 = output_wb.sheets[sheet_name].range('A1')
    copy_range_exact(src_range2, dest_range2)

# === Save the Final Workbook ===
try:
    output_dir = os.path.dirname(output_path)
    if not os.path.exists(output_dir):
        os.makedirs(output_dir)

    output_wb.save(output_path)
    print(f"✅ File saved successfully at: {output_path}")
except Exception as e:
    print(f"❌ Failed to save file: {e}")

# === Clean Up ===
output_wb.close()
wb.close()
app.quit()