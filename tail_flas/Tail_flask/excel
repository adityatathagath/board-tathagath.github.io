Sub ProcessRiskFactorReturns()

    Dim wbTarget As Workbook
    Dim wbMarket As Workbook
    Dim wbTemplate As Workbook
    Dim wsReturns As Worksheet, wsMFF As Worksheet, wsTS As Worksheet
    Dim wsMarketReturns As Worksheet, wsMarketMFF As Worksheet, wsMarketTS As Worksheet
    Dim wsTemplate As Worksheet, wsRiskReturns As Worksheet
    Dim lastRow As Long, lastCol As Long
    Dim rfDict As Object
    Dim fileMarket As String, fileTemplate As String

    ' === Set paths ===
    fileMarket = "C:\path\to\marketwatch.xlsb"
    fileTemplate = "C:\path\to\risk_factors_returns_template.xlsx"

    Set wbTarget = ThisWorkbook  ' Assumes you're running macro from target file

    ' === Create required sheets if missing ===
    Dim sheetNames As Variant: sheetNames = Array("Returns", "MFF", "Time Series", "DVaR - Chart-Returns", "Risk Factor Returns")
    Dim i As Long
    For i = LBound(sheetNames) To UBound(sheetNames)
        On Error Resume Next
        Set ws = wbTarget.Sheets(sheetNames(i))
        On Error GoTo 0
        If ws Is Nothing Then
            wbTarget.Sheets.Add(After:=wbTarget.Sheets(wbTarget.Sheets.Count)).Name = sheetNames(i)
        End If
        Set ws = Nothing
    Next i

    Set wsReturns = wbTarget.Sheets("Returns")
    Set wsMFF = wbTarget.Sheets("MFF")
    Set wsTS = wbTarget.Sheets("Time Series")
    Set wsRiskReturns = wbTarget.Sheets("Risk Factor Returns")

    ' === Open marketwatch.xlsb ===
    Set wbMarket = Workbooks.Open(fileMarket, ReadOnly:=True)
    Set wsMarketReturns = wbMarket.Sheets("Returns")
    Set wsMarketTS = wbMarket.Sheets("TimeSeries")
    Set wsMarketMFF = wbMarket.Sheets("MFF Scalar")

    ' === Copy data from marketwatch â†’ target ===
    wsTS.Cells.Clear
    wsMarketTS.UsedRange.Copy wsTS.Range("A1")

    wsReturns.Cells.Clear
    wsMarketReturns.UsedRange.Copy wsReturns.Range("A1")

    wsMFF.Cells.Clear
    wsMarketMFF.UsedRange.Copy wsMFF.Range("A1")

    ' === Open Template ===
    Set wbTemplate = Workbooks.Open(fileTemplate, ReadOnly:=True)
    Set wsTemplate = wbTemplate.Sheets(1) ' Assuming only 1 sheet

    ' === Fill Dates in Template A6 down ===
    lastRow = wsReturns.Cells(wsReturns.Rows.Count, 1).End(xlUp).Row
    wsTemplate.Range("A6").Resize(lastRow - 1).Value = wsReturns.Range("A2:A" & lastRow).Value

    ' === Create Dictionary for risk factor headers ===
    Set rfDict = CreateObject("Scripting.Dictionary")
    lastCol = wsReturns.Cells(1, wsReturns.Columns.Count).End(xlToLeft).Column
    For i = 2 To lastCol
        rfDict(wsReturns.Cells(1, i).Value) = i
    Next i

    ' === Fill B6:... from Returns into Template ===
    Dim rfName As String
    Dim rfColTemplate As Long
    Dim rowOffset As Long, colOffset As Long
    Dim dateCount As Long

    dateCount = lastRow - 1
    rfColTemplate = wsTemplate.Cells(1, wsTemplate.Columns.Count).End(xlToLeft).Column

    For colOffset = 2 To rfColTemplate
        rfName = wsTemplate.Cells(1, colOffset).Value
        If rfDict.exists(rfName) Then
            wsTemplate.Cells(6, colOffset).Resize(dateCount).Value = _
                wsReturns.Cells(2, rfDict(rfName)).Resize(dateCount).Value
        End If
    Next colOffset

    ' === Copy B6:... with formatting to Risk Factor Returns ===
    wsTemplate.Range("B6").CurrentRegion.Copy
    wsRiskReturns.Range("B6").PasteSpecial Paste:=xlPasteAllUsingSourceTheme

    ' === Cleanup ===
    Application.CutCopyMode = False
    wbTarget.Save
    wbMarket.Close SaveChanges:=False
    wbTemplate.Close SaveChanges:=False

    MsgBox "All done!"

End Sub
