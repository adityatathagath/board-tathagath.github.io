Sub Run_Full_RiskFactor_Processing()

    Dim wbTarget As Workbook, wbMarket As Workbook, wbTemplate As Workbook
    Dim wsReturns As Worksheet, wsMFF As Worksheet, wsTS As Worksheet
    Dim wsMarketReturns As Worksheet, wsMarketMFF As Worksheet, wsMarketTS As Worksheet
    Dim wsTemplate As Worksheet, wsRiskReturns As Worksheet
    Dim lastRow As Long, lastCol As Long
    Dim rfDict As Object
    Dim fileTarget As String, fileMarket As String, fileTemplate As String
    Dim i As Long

    ' === Set file paths ===
    fileTarget = "C:\path\to\target_file.xlsx"
    fileMarket = "C:\path\to\marketwatch.xlsb"
    fileTemplate = "C:\path\to\risk_factors_returns_template.xlsx"

    ' === Open target file ===
    Set wbTarget = Workbooks.Open(fileTarget)
    
    ' === Create required sheets if missing ===
    Dim sheetNames As Variant: sheetNames = Array("Returns", "MFF", "Time Series", "DVaR - Chart-Returns", "Risk Factor Returns")
    For i = LBound(sheetNames) To UBound(sheetNames)
        On Error Resume Next
        Set ws = wbTarget.Sheets(sheetNames(i))
        On Error GoTo 0
        If ws Is Nothing Then
            wbTarget.Sheets.Add(After:=wbTarget.Sheets(wbTarget.Sheets.Count)).Name = sheetNames(i)
        End If
        Set ws = Nothing
    Next i

    Set wsReturns = wbTarget.Sheets("Returns")
    Set wsMFF = wbTarget.Sheets("MFF")
    Set wsTS = wbTarget.Sheets("Time Series")
    Set wsRiskReturns = wbTarget.Sheets("Risk Factor Returns")

    ' === Open marketwatch.xlsb ===
    Set wbMarket = Workbooks.Open(fileMarket, ReadOnly:=True)
    Set wsMarketReturns = wbMarket.Sheets("Returns")
    Set wsMarketTS = wbMarket.Sheets("TimeSeries")
    Set wsMarketMFF = wbMarket.Sheets("MFF Scalar")

    ' === Copy data from marketwatch â†’ target ===
    wsTS.Cells.Clear
    wsMarketTS.UsedRange.Copy wsTS.Range("A1")

    wsReturns.Cells.Clear
    wsMarketReturns.UsedRange.Copy wsReturns.Range("A1")

    wsMFF.Cells.Clear
    wsMarketMFF.UsedRange.Copy wsMFF.Range("A1")

    ' === Open template ===
    Set wbTemplate = Workbooks.Open(fileTemplate, ReadOnly:=True)
    Set wsTemplate = wbTemplate.Sheets(1) ' Assuming only 1 sheet

    ' === Copy Dates to Template ===
    lastRow = wsReturns.Cells(wsReturns.Rows.Count, 1).End(xlUp).Row
    wsTemplate.Range("A6").Resize(lastRow - 1).Value = wsReturns.Range("A2:A" & lastRow).Value

    ' === Create header dictionary ===
    Set rfDict = CreateObject("Scripting.Dictionary")
    lastCol = wsReturns.Cells(1, wsReturns.Columns.Count).End(xlToLeft).Column
    For i = 2 To lastCol
        rfDict(wsReturns.Cells(1, i).Value) = i
    Next i

    ' === Fill matrix B6:... in Template ===
    Dim rfName As String, rfColTemplate As Long
    Dim rowOffset As Long, colOffset As Long
    Dim dateCount As Long

    dateCount = lastRow - 1
    rfColTemplate = wsTemplate.Cells(1, wsTemplate.Columns.Count).End(xlToLeft).Column

    For colOffset = 2 To rfColTemplate
        rfName = wsTemplate.Cells(1, colOffset).Value
        If rfDict.exists(rfName) Then
            wsTemplate.Cells(6, colOffset).Resize(dateCount).Value = _
                wsReturns.Cells(2, rfDict(rfName)).Resize(dateCount).Value
        End If
    Next colOffset

    ' === Copy matrix to Risk Factor Returns with formatting ===
    wsTemplate.Range("B6").CurrentRegion.Copy
    wsRiskReturns.Range("B6").PasteSpecial Paste:=xlPasteAllUsingSourceTheme

    ' === Cleanup ===
    Application.CutCopyMode = False
    wbTarget.Save
    wbMarket.Close SaveChanges:=False
    wbTemplate.Close SaveChanges:=False
    wbTarget.Close

    MsgBox "Macro completed successfully!", vbInformation

End Sub
