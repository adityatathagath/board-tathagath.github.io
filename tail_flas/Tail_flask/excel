import xlwings as xw
from pathlib import Path

# === Define File Paths ===
target_path = Path(r"C:\path\to\target_file.xlsx")  # <- Update this
marketwatch_path = Path(r"C:\path\to\marketwatch.xlsb")  # <- Update this
template_path = Path(r"C:\path\to\risk_factors_returns_template.xlsx")  # <- Update this

# === Launch Excel ===
app = xw.App(visible=False)
app.display_alerts = False
app.screen_updating = False

# === Open Files ===
target_wb = app.books.open(str(target_path))
market_wb = app.books.open(str(marketwatch_path))
template_wb = app.books.open(str(template_path))

# === Step 1: Create Required Sheets in Target ===
required_sheets = ['Returns', 'MFF', 'Time Series', 'DVaR - Chart-Returns', 'Risk Factor Returns']
existing_sheets = [s.name for s in target_wb.sheets]

for sheet_name in required_sheets:
    if sheet_name not in existing_sheets:
        target_wb.sheets.add(name=sheet_name)

# === Step 2: Copy Data from marketwatch.xlsb ===
sheet_map = {
    'TimeSeries': 'Time Series',
    'Returns': 'Returns',
    'MFF Scalar': 'MFF'
}

for src, dest in sheet_map.items():
    src_sheet = market_wb.sheets[src]
    dest_sheet = target_wb.sheets[dest]
    dest_sheet.clear()
    src_sheet.used_range.copy(dest_sheet.range("A1"))

# === Step 3: Fill Template with Returns Data ===
returns_sheet = target_wb.sheets["Returns"]
template_sheet = template_wb.sheets[0]  # First sheet in template
risk_factor_returns_sheet = target_wb.sheets["Risk Factor Returns"]

# Get Dates from Returns sheet
dates = returns_sheet.range("A2").expand('down').value  # Skips header
template_sheet.range("A6").options(transpose=True).value = dates

# Get risk factor headers from template
risk_factors = template_sheet.range("B1").expand('right').value

# Get data from Returns sheet
returns_header = returns_sheet.range("B1").expand('right').value
returns_data = returns_sheet.range("B2").expand('table').value

# Create column index map
header_index_map = {rf: i for i, rf in enumerate(returns_header)}

# Fill B6:AM265 with corresponding values
for row_i, date in enumerate(dates):
    for col_j, rf in enumerate(risk_factors):
        if rf in header_index_map:
            val = returns_data[row_i][header_index_map[rf]]
            template_sheet.range((6 + row_i, 2 + col_j)).value = val

# === Step 4: Copy from Template to Risk Factor Returns with formatting ===
filled_range = template_sheet.range("B6").expand()
filled_range.copy(risk_factor_returns_sheet.range("B6"), paste='all')

# === Step 5: Save Target and Close All Files ===
target_wb.save()
market_wb.close()
template_wb.close(save_changes=False)
target_wb.close()
app.quit()
