import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import matplotlib.dates as mdates
import numpy as np
import matplotlib.gridspec as gridspec

# 🔁 CHANGE THIS TO YOUR FILE PATH
file_path = "path_to_your_excel_file.xlsx"  # e.g. "C:/Users/aditya/Documents/macro_pnl.xlsx"

# Load data
df = pd.read_excel(file_path, parse_dates=["Business Date"])

# Barclays theme colors
barclays_blue = "#00A3E0"
barclays_grey = "#4C4C4C"

# Preprocessing
df.sort_values("Business Date", inplace=True)
df["Cumulative Actual"] = df.groupby("GMIS Level 05 Name")["Formal Daily Balance"].cumsum()
df["Cumulative Budget"] = df.groupby("GMIS Level 05 Name")["Budget Daily Balance"].cumsum()

# Aggregated Macro Desk Total
macro_df = df[df["GMIS Level 04 Name"].isin(["FX", "Rates", "EM Macro"])]
macro_agg = macro_df.groupby("Business Date")[["Formal Daily Balance", "Budget Daily Balance"]].sum().cumsum()

# Macro Category Breakdown
grouped = df.groupby(["Business Date", "GMIS Level 04 Name"])[["Formal Daily Balance", "Budget Daily Balance"]].sum().reset_index()
pivot_actual = grouped.pivot(index="Business Date", columns="GMIS Level 04 Name", values="Formal Daily Balance").cumsum()
pivot_budget = grouped.pivot(index="Business Date", columns="GMIS Level 04 Name", values="Budget Daily Balance").cumsum()

# Sub-Desk Aggregates
agg_subdesk = df.groupby("GMIS Level 05 Name")[["Formal Daily Balance", "Budget Daily Balance"]].sum().sort_values("Formal Daily Balance", ascending=False)

# Bubble chart data prep
df["Deviation"] = df["Formal Daily Balance"] - df["Budget Daily Balance"]
bubble_data = df.groupby(["Business Date", "GMIS Level 05 Name"])["Deviation"].sum().reset_index()
bubble_data["Size"] = bubble_data["Deviation"].abs()
bubble_data["Color"] = np.where(bubble_data["Deviation"] >= 0, barclays_blue, "#E1251B")

# Map sub-desks to numeric y values
subdesk_map = {desk: i for i, desk in enumerate(sorted(bubble_data["GMIS Level 05 Name"].unique()))}
bubble_data["Y"] = bubble_data["GMIS Level 05 Name"].map(subdesk_map)

# Canvas Setup
fig = plt.figure(constrained_layout=True, figsize=(20, 22))
spec = gridspec.GridSpec(ncols=2, nrows=3, figure=fig)

# Chart 1: Total Macro Cumulative P&L
ax1 = fig.add_subplot(spec[0, :])
ax1.plot(macro_agg.index, macro_agg["Formal Daily Balance"], label="Cumulative Actual", color=barclays_blue, linewidth=2)
ax1.plot(macro_agg.index, macro_agg["Budget Daily Balance"], label="Cumulative Budget", color=barclays_grey, linestyle="--", linewidth=2)
ax1.set_title("Total Macro Cumulative P&L vs Budget", fontsize=14, weight='bold')
ax1.set_xlabel("Date")
ax1.set_ylabel("Cumulative P&L")
ax1.legend()
ax1.grid(True, linestyle='--', alpha=0.5)
ax1.xaxis.set_major_formatter(mdates.DateFormatter('%b %d'))

# Chart 2: By Macro Desk
ax2 = fig.add_subplot(spec[1, :])
for col in pivot_actual.columns:
    ax2.plot(pivot_actual.index, pivot_actual[col], label=f"{col} Actual", linewidth=2)
    ax2.plot(pivot_budget.index, pivot_budget[col], linestyle='--', label=f"{col} Budget", linewidth=2)
ax2.set_title("Cumulative P&L vs Budget by Macro Desk", fontsize=14, weight='bold')
ax2.set_xlabel("Date")
ax2.set_ylabel("Cumulative P&L")
ax2.legend()
ax2.grid(True, linestyle='--', alpha=0.5)
ax2.xaxis.set_major_formatter(mdates.DateFormatter('%b %d'))

# Chart 3: Bar Chart by Subdesk
ax3 = fig.add_subplot(spec[2, 0])
agg_subdesk.plot(kind='bar', ax=ax3, color=[barclays_blue, barclays_grey])
ax3.set_title("Total P&L vs Budget by Sub-Desk", fontsize=14, weight='bold')
ax3.set_ylabel("Total P&L")
ax3.grid(axis='y', linestyle='--', alpha=0.6)
ax3.tick_params(axis='x', rotation=45)

# Chart 4: Bubble Chart for Deviation
ax4 = fig.add_subplot(spec[2, 1])
ax4.scatter(
    x=bubble_data["Business Date"],
    y=bubble_data["Y"],
    s=bubble_data["Size"] * 15,
    c=bubble_data["Color"],
    alpha=0.7,
    edgecolors="black"
)
ax4.set_yticks(list(subdesk_map.values()))
ax4.set_yticklabels(list(subdesk_map.keys()))
ax4.set_title("P&L Deviation Bubble Chart (Actual - Budget)", fontsize=14, weight='bold')
ax4.set_xlabel("Date")
ax4.set_ylabel("Sub-Desk")
ax4.grid(True, linestyle='--', alpha=0.4)
ax4.xaxis.set_major_formatter(mdates.DateFormatter('%b %d'))

plt.suptitle("Macro Risk Daily P&L Overview", fontsize=16, weight='bold')
plt.show()