Sub ExportDVaRAndSVaRWithFullRefresh()

    Dim srcWB As Workbook
    Dim newWB As Workbook
    Dim summaryWS As Worksheet
    Dim iceWS As Worksheet
    Dim icePrevWS As Worksheet
    Dim destWS As Worksheet
    Dim rank As Integer
    Dim varType As Variant
    Dim rng1 As Range, rng2 As Range
    Dim savePath As String

    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    Application.Calculation = xlCalculationManual

    Set srcWB = ThisWorkbook
    Set summaryWS = srcWB.Sheets("summary")
    Set iceWS = srcWB.Sheets("ice")
    Set icePrevWS = srcWB.Sheets("ice_prev_cob")

    ' Create a completely new workbook
    Set newWB = Workbooks.Add
    ' Remove default sheet
    Application.DisplayAlerts = False
    Do While newWB.Sheets.Count > 0
        newWB.Sheets(1).Delete
    Loop
    Application.DisplayAlerts = True

    ' Loop over both Var types
    For Each varType In Array("DVaR", "SVaR")

        summaryWS.Range("C3").Value = varType ' Set Var
        summaryWS.Range("A1").Value = "Running " & varType

        ' ---- Refresh before copying summary block ----
        Application.StatusBar = "Refreshing sheets for " & varType & " summary block..."
        icePrevWS.Calculate
        DoEvents
        iceWS.Calculate
        DoEvents
        summaryWS.Calculate
        DoEvents

        ' ---- Copy AA14:BB54 to main varType sheet ----
        Application.StatusBar = "Copying " & varType & " summary block..."
        Set rng1 = summaryWS.Range("AA14:BB54")
        rng1.Copy

        Set destWS = newWB.Sheets.Add(After:=newWB.Sheets(newWB.Sheets.Count))
        destWS.Name = varType

        With destWS.Range("A1")
            .PasteSpecial Paste:=xlPasteFormats
            .PasteSpecial Paste:=xlPasteValuesAndNumberFormats
        End With
        Application.CutCopyMode = False

        ' ---- Loop over P&L Ranks ----
        For rank = 1 To 3
            summaryWS.Range("C2").Value = rank ' Set P&L Rank
            summaryWS.Range("A1").Value = "Running " & varType & " PL" & rank

            ' Refresh again for each Rank
            Application.StatusBar = "Refreshing for " & varType & " PL" & rank
            icePrevWS.Calculate
            DoEvents
            iceWS.Calculate
            DoEvents
            summaryWS.Calculate
            DoEvents

            ' Copy PL block
            Set rng2 = summaryWS.Range("B13:Y140")
            rng2.Copy

            Set destWS = newWB.Sheets.Add(After:=newWB.Sheets(newWB.Sheets.Count))
            destWS.Name = varType & " PL" & rank

            With destWS.Range("A1")
                .PasteSpecial Paste:=xlPasteFormats
                .PasteSpecial Paste:=xlPasteValuesAndNumberFormats
            End With
            Application.CutCopyMode = False
        Next rank

    Next varType

    ' Save final workbook
    savePath = srcWB.Path & "\" & "VaR_Export_" & Format(Now, "yyyymmdd_hhmmss") & ".xlsx"
    newWB.SaveAs Filename:=savePath, FileFormat:=xlOpenXMLWorkbook

    newWB.Close SaveChanges:=False
    summaryWS.Range("A1").Value = "Export Completed"
    Application.StatusBar = "Export completed and saved to: " & savePath
    MsgBox "Export complete!" & vbCrLf & savePath, vbInformation

    ' Reset Excel environment
    Application.Calculation = xlCalculationAutomatic
    Application.DisplayAlerts = True
    Application.ScreenUpdating = True
    Application.StatusBar = False

End Sub