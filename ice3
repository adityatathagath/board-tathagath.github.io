import xlwings as xw
import os

# === Define Helper Function ===
def copy_range_exact(src_range, dest_sheet, top_left_cell_address='A1'):
    # Activate the destination sheet and cell
    dest_sheet.activate()
    dest_cell = dest_sheet.range(top_left_cell_address)
    dest_cell.select()

    # Copy and paste with all formatting (xlPasteAll = -4104)
    src_range.api.Copy()
    dest_cell.api.Worksheet.Paste(dest_cell.api, -4104)

# === File Paths ===
source_path = r"C:\path\to\ice_vectors.xlsb"  # üîÅ Update this
output_path = r"C:\path\to\output\DVaR_Output.xlsx"  # üîÅ Update this

# === Start Excel & Open Workbook ===
app = xw.App(visible=False)  # Change to True for debugging
wb = app.books.open(source_path)
summary = wb.sheets['summary']

# === Refresh All Calculations ===
app.calculate()

# === Set Var = 'DVaR' ===
summary.range('C3').value = "DVaR"

# === Create New Output Workbook ===
output_wb = xw.Book()
output_wb.sheets[0].name = 'DVaR'

for rank in range(1, 4):
    # Set P&L Rank
    summary.range('C2').value = rank
    app.calculate()

    # For Rank 1: Copy AA14:BB54 ‚Üí DVaR
    if rank == 1:
        src_range1 = summary.range('AA14:BB54')
        dest_sheet1 = output_wb.sheets['DVaR']
        copy_range_exact(src_range1, dest_sheet1, 'A1')

    # Copy B13:Y140 ‚Üí DVaR PL1 / PL2 / PL3
    sheet_name = f"DVaR PL{rank}"
    output_wb.sheets.add(name=sheet_name)
    dest_sheet2 = output_wb.sheets[sheet_name]
    src_range2 = summary.range('B13:Y140')
    copy_range_exact(src_range2, dest_sheet2, 'A1')

# === Save Final Output ===
try:
    output_dir = os.path.dirname(output_path)
    if not os.path.exists(output_dir):
        os.makedirs(output_dir)

    output_wb.save(output_path)
    print(f"‚úÖ File saved successfully at: {output_path}")
except Exception as e:
    print(f"‚ùå Failed to save file: {e}")

# === Cleanup ===
output_wb.close()
wb.close()
app.quit()